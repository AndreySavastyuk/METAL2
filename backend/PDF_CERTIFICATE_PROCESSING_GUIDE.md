# –°–∏—Å—Ç–µ–º–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ PDF —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –¥–ª—è MetalQMS

## –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ PDF —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ, –ø–∞—Ä—Å–∏–Ω–≥ –∏ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö –∏–∑ PDF –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –∫–∞—á–µ—Å—Ç–≤–∞ –º–µ—Ç–∞–ª–ª–æ–≤. –í–∫–ª—é—á–∞–µ—Ç –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫, –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –ø—Ä–µ–≤—å—é –∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É —á–µ—Ä–µ–∑ Celery.

## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### üìÑ –û–±—Ä–∞–±–æ—Ç–∫–∞ PDF –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Å –ø–æ–º–æ—â—å—é pypdf –∏ PyMuPDF
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã—Ö –∏ —Å–ª–æ–∂–Ω—ã—Ö PDF —Ñ–∞–π–ª–æ–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–¥–∏—Ä–æ–≤–∫–∏ —Ç–µ–∫—Å—Ç–∞
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–∞ (—Ä–∞–∑–º–µ—Ä, —Ö–µ—à)

### üîç –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
- –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –º–∞—Ä–∫–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –ø–ª–∞–≤–∫–∏
- –ü–∞—Ä—Å–∏–Ω–≥ –Ω–æ–º–µ—Ä–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
- –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–µ
- –ê–Ω–∞–ª–∏–∑ —Ö–∏–º–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—Å—Ç–∞–≤–∞
- –ü–∞—Ä—Å–∏–Ω–≥ –º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏—Ö —Å–≤–æ–π—Å—Ç–≤
- –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏—Å–ø—ã—Ç–∞–Ω–∏–π

### üñºÔ∏è –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–µ–≤—å—é
- –°–æ–∑–¥–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã PDF
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∏–Ω–∏–∞—Ç—é—Ä –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—ã—Å–æ–∫–æ–≥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è

### üîé –ü–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫
- –ü–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º—É —Ç–µ–∫—Å—Ç—É —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
- –ü–æ–∏—Å–∫ –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º
- –ê–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤
- –†–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ PostgreSQL full-text search

### ‚ö° –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
- –û–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ Celery –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
- Retry –ª–æ–≥–∏–∫–∞ —Å exponential backoff
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å—Ç–∞—Ç—É—Å–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- –ü–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

```
PDF –§–∞–π–ª ‚Üí CertificateProcessor ‚Üí Celery Tasks ‚Üí –ü–æ–∏—Å–∫–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å
    ‚Üì              ‚Üì                   ‚Üì              ‚Üì
–ó–∞–≥—Ä—É–∑–∫–∞ ‚Üí –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ ‚Üí –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è ‚Üí –ü–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π
           –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö      –æ–±—Ä–∞–±–æ—Ç–∫–∞     –ø–æ–∏—Å–∫
           –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–µ–≤—å—é    –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è   API
```

### –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö

1. **CertificateSearchIndex** - –ø–æ–∏—Å–∫–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
2. **CertificatePreview** - –ø—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤  
3. **ProcessingLog** - –ª–æ–≥–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–ª—è –∞—É–¥–∏—Ç–∞

### –°–µ—Ä–≤–∏—Å—ã

1. **CertificateProcessor** - –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏
2. **Celery Tasks** - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
3. **API ViewSets** - REST API –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
pip install PyMuPDF>=1.23.0 pypdf>=3.17.0 Pillow>=10.0.0
```

### 2. –ú–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```bash
python manage.py makemigrations certificates
python manage.py migrate
```

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Celery

```python
# settings.py
CELERY_BEAT_SCHEDULE = {
    'cleanup-failed-certificate-processing': {
        'task': 'apps.certificates.tasks.cleanup_failed_processing',
        'schedule': 1800.0,  # –ö–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç
    },
    'update-certificate-search-statistics': {
        'task': 'apps.certificates.tasks.update_search_statistics', 
        'schedule': 3600.0,  # –ö–∞–∂–¥—ã–π —á–∞—Å
    },
}
```

### 4. –ó–∞–ø—É—Å–∫ Celery

```bash
# Worker –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–¥–∞—á
celery -A config worker -l info

# Beat –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
celery -A config beat -l info
```

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤

```python
from apps.warehouse.models import Certificate, Material

# –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É)
certificate = Certificate.objects.create(
    material=material,
    pdf_file=uploaded_file
)
# –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ Celery
```

### –ü–æ–∏—Å–∫ –≤ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞—Ö

```python
from apps.certificates.services import certificate_processor

# –ü–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫
results = certificate_processor.search_in_certificates(
    query="40X –ø–ª–∞–≤–∫–∞",
    limit=20
)

for result in results:
    print(f"–ú–∞—Ç–µ—Ä–∏–∞–ª: {result['grade']}")
    print(f"–ü–ª–∞–≤–∫–∞: {result['heat_number']}")
    print(f"–†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å: {result['match_score']}")
```

### –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ PDF

```python
# –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
text = certificate_processor.extract_text_from_pdf('/path/to/certificate.pdf')

# –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö
parsed_data = certificate_processor.parse_certificate_data(text)

print(f"–ú–∞—Ä–∫–∞: {parsed_data.get('grade')}")
print(f"–ü–ª–∞–≤–∫–∞: {parsed_data.get('heat_number')}")
print(f"–•–∏–º—Å–æ—Å—Ç–∞–≤: {parsed_data.get('chemical_composition')}")
```

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–µ–≤—å—é

```python
# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–µ–≤—å—é –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
preview_url = certificate_processor.generate_certificate_preview(pdf_file)
```

## Management –∫–æ–º–∞–Ω–¥—ã

### –ú–∞—Å—Å–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤

```bash
# –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤—Å–µ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
python manage.py reprocess_all_certificates

# –ü–µ—Ä–µ–æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤—Å–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –∑–∞–Ω–æ–≤–æ
python manage.py reprocess_all_certificates --force

# –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
python manage.py reprocess_all_certificates --ids 1,2,3

# –¢–æ–ª—å–∫–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
python manage.py reprocess_all_certificates --text-only

# –¢–æ–ª—å–∫–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–µ–≤—å—é
python manage.py reprocess_all_certificates --preview-only

# –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ Celery
python manage.py reprocess_all_certificates --async

# –ü–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
python manage.py reprocess_all_certificates --batch-size 50

# –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
python manage.py reprocess_all_certificates --stats

# Dry run - –ø–æ–∫–∞–∑–∞—Ç—å —á—Ç–æ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ
python manage.py reprocess_all_certificates --dry-run
```

### –§–∏–ª—å—Ç—Ä—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏

```bash
# –¢–æ–ª—å–∫–æ –Ω–µ—É–¥–∞—á–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ
python manage.py reprocess_all_certificates --failed-only

# –¢–æ–ª—å–∫–æ –±–µ–∑ –ø—Ä–µ–≤—å—é
python manage.py reprocess_all_certificates --missing-preview

# –¢–æ–ª—å–∫–æ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞
python manage.py reprocess_all_certificates --missing-text
```

## REST API

### –ü–æ–∏—Å–∫ –≤ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞—Ö

```http
GET /api/certificates/processing/search/?q=40X&limit=20
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "query": "40X",
  "total_results": 5,
  "results": [
    {
      "certificate_id": 1,
      "grade": "40X",
      "heat_number": "H12345",
      "certificate_number": "CERT-001",
      "supplier": "–ú–µ—Ç–∞–ª–ª–¢–æ—Ä–≥",
      "match_score": 10.0,
      "matched_fields": ["grade", "text"],
      "preview_url": "/media/certificates/previews/cert_1_preview.png"
    }
  ]
}
```

### –ê–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ

```http
GET /api/certificates/processing/suggestions/?q=40&type=grade
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "query": "40",
  "suggestions": [
    {"type": "grade", "value": "40X", "label": "–ú–∞—Ä–∫–∞: 40X"},
    {"type": "grade", "value": "40X–ù", "label": "–ú–∞—Ä–∫–∞: 40X–ù"}
  ]
}
```

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏

```http
GET /api/certificates/processing/statistics/
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "total_certificates": 150,
  "unprocessed": 10,
  "processing": {
    "success_rate": 94.3,
    "completed": 133,
    "failed": 7,
    "pending": 10
  },
  "previews": {
    "preview_rate": 89.3,
    "completed_previews": 134
  }
}
```

### –°—Ç–∞—Ç—É—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞

```http
GET /api/certificates/processing/1/processing_status/
```

### –ü–µ—Ä–µ–æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞

```http
POST /api/certificates/processing/1/reprocess/
```

### –ü–∞–∫–µ—Ç–Ω–∞—è –ø–µ—Ä–µ–æ–±—Ä–∞–±–æ—Ç–∫–∞

```http
POST /api/certificates/processing/reprocess_batch/
Content-Type: application/json

{
  "certificate_ids": [1, 2, 3],
  "force": true
}
```

## Celery –∑–∞–¥–∞—á–∏

### –û—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏

#### process_uploaded_certificate
–ü–æ–ª–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞:
- –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
- –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö  
- –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–µ–≤—å—é

```python
from apps.certificates.tasks import process_uploaded_certificate

# –ó–∞–ø—É—Å–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏
task = process_uploaded_certificate.delay(certificate_id=1)
```

#### generate_certificate_preview
–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–µ–≤—å—é —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞:

```python
from apps.certificates.tasks import generate_certificate_preview

task = generate_certificate_preview.delay(certificate_id=1)
```

#### reprocess_certificates_batch
–ü–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤:

```python
from apps.certificates.tasks import reprocess_certificates_batch

task = reprocess_certificates_batch.delay(
    certificate_ids=[1, 2, 3],
    force_reprocess=True
)
```

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏

- **cleanup_failed_processing** - –æ—á–∏—Å—Ç–∫–∞ –∑–∞–≤–∏—Å—à–∏—Ö –æ–±—Ä–∞–±–æ—Ç–æ–∫ (–∫–∞–∂–¥—ã–µ 30 –º–∏–Ω)
- **update_search_statistics** - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (–∫–∞–∂–¥—ã–π —á–∞—Å)
- **optimize_search_index** - –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏–Ω–¥–µ–∫—Å–∞ (—Ä–∞–∑ –≤ –¥–µ–Ω—å)

## –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ

### Django –∞–¥–º–∏–Ω–∫–∞

–î–æ—Å—Ç—É–ø–Ω—ã –∞–¥–º–∏–Ω–∫–∏ –¥–ª—è:

1. **CertificateSearchIndex** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–∏—Å–∫–æ–≤—ã–º–∏ –∏–Ω–¥–µ–∫—Å–∞–º–∏
2. **CertificatePreview** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
3. **ProcessingLog** - –ø—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∫–∏

### –î–µ–π—Å—Ç–≤–∏—è –≤ –∞–¥–º–∏–Ω–∫–µ

- –ü–µ—Ä–µ–æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
- –†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–µ–≤—å—é
- –û—á–∏—Å—Ç–∫–∞ –æ—à–∏–±–æ–∫
- –ü—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

#### –õ–æ–≥–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏
–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ –º–æ–¥–µ–ª—å `ProcessingLog`:

```python
# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
logs = ProcessingLog.objects.filter(certificate_id=1)

for log in logs:
    print(f"{log.operation}: {log.status} ({log.duration_seconds}s)")
```

#### –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –í—Ä–µ–º—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞
- –í—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–µ–≤—å—é
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω—ã—Ö/–Ω–µ—É–¥–∞—á–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç–æ–∫
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—à–∏–±–æ–∫

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –¢–∏–ø—ã –æ—à–∏–±–æ–∫

1. **–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã–µ PDF —Ñ–∞–π–ª—ã**
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –ø–∞—Ä—Å–µ—Ä–∞–º–∏
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

2. **–û—à–∏–±–∫–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞**
   - Retry –ª–æ–≥–∏–∫–∞ —Å exponential backoff
   - Fallback –Ω–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã

3. **–û—à–∏–±–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–µ–≤—å—é**
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤ –±–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—à–∏–±–æ–∫

```python
# –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏
from django.db.models import Count

errors = CertificateSearchIndex.objects.filter(
    processing_status='failed'
).values('error_message').annotate(
    count=Count('id')
).order_by('-count')
```

## –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤

```python
# settings.py
DATA_UPLOAD_MAX_MEMORY_SIZE = 50 * 1024 * 1024  # 50MB
FILE_UPLOAD_MAX_MEMORY_SIZE = 50 * 1024 * 1024  # 50MB

# Celery
CELERY_TASK_TIME_LIMIT = 300  # 5 –º–∏–Ω—É—Ç –Ω–∞ –∑–∞–¥–∞—á—É
CELERY_TASK_SOFT_TIME_LIMIT = 240  # 4 –º–∏–Ω—É—Ç—ã –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
```

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞

```python
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ PostgreSQL
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'OPTIONS': {
            'options': '-c default_text_search_config=russian'
        }
    }
}
```

### –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

```python
# –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
from django.core.cache import cache

def cached_search(query, limit=50):
    cache_key = f"cert_search:{query}:{limit}"
    results = cache.get(cache_key)
    
    if results is None:
        results = certificate_processor.search_in_certificates(query, limit)
        cache.set(cache_key, results, 300)  # 5 –º–∏–Ω—É—Ç
    
    return results
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤

```python
def validate_pdf_file(file):
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
    if not file.name.endswith('.pdf'):
        raise ValidationError('–¢–æ–ª—å–∫–æ PDF —Ñ–∞–π–ª—ã —Ä–∞–∑—Ä–µ—à–µ–Ω—ã')
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞
    if file.size > 50 * 1024 * 1024:  # 50MB
        raise ValidationError('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π')
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ magic number
    file.seek(0)
    header = file.read(4)
    if header != b'%PDF':
        raise ValidationError('–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã–π PDF —Ñ–∞–π–ª')
```

### –ö–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞

```python
# –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –≤ API
class CertificateProcessingViewSet(viewsets.ViewSet):
    permission_classes = [permissions.IsAuthenticated]
    
    def reprocess(self, request, pk=None):
        if not request.user.has_perm('warehouse.change_certificate'):
            return Response(status=403)
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç

```bash
python test_pdf_processing.py
```

–°–∫—Ä–∏–ø—Ç —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç:
- –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∏–∑ PDF
- –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—é –ø—Ä–µ–≤—å—é
- –ü–æ–∏—Å–∫ –≤ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞—Ö
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É

### Unit —Ç–µ—Å—Ç—ã

```python
class CertificateProcessorTestCase(TestCase):
    def test_text_extraction(self):
        processor = CertificateProcessor()
        text = processor.extract_text_from_pdf('test_certificate.pdf')
        self.assertIsNotNone(text)
        self.assertGreater(len(text), 100)
    
    def test_data_parsing(self):
        text = "–ú–∞—Ä–∫–∞ —Å—Ç–∞–ª–∏: 40X\n–ü–ª–∞–≤–∫–∞ ‚Ññ 12345"
        parsed = processor.parse_certificate_data(text)
        self.assertEqual(parsed['grade'], '40X')
        self.assertEqual(parsed['heat_number'], '12345')
```

## –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

### Docker –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

```yaml
version: '3.8'
services:
  app:
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
    volumes:
      - ./media:/app/media
      
  celery_worker:
    command: celery -A config worker -l info
    volumes:
      - ./media:/app/media
      
  celery_beat:
    command: celery -A config beat -l info
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ

```bash
# Flower –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ Celery
celery -A config flower --port=5555

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
tail -f /var/log/metalqms/certificate_processing.log
```

## FAQ

### Q: PDF –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è
A: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
- –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (–º–∞–∫—Å. 50MB)
- –§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ (—Ç–æ–ª—å–∫–æ PDF)
- –°—Ç–∞—Ç—É—Å Celery worker
- –õ–æ–≥–∏ –≤ ProcessingLog

### Q: –ü–æ–∏—Å–∫ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
A: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
- –°—Ç–∞—Ç—É—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ CertificateSearchIndex
- –ù–∞–ª–∏—á–∏–µ –∏–∑–≤–ª–µ—á–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ PostgreSQL full-text search

### Q: –ú–µ–¥–ª–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
A: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:
- –£–≤–µ–ª–∏—á—å—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ Celery workers
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ SSD –¥–ª—è —Ñ–∞–π–ª–æ–≤
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è

### Q: –û—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö
A: –£–ª—É—á—à–µ–Ω–∏–µ:
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è
- –î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –≤ CertificateProcessor
- –û–±—É—á–∏—Ç–µ —Å–∏—Å—Ç–µ–º—É –Ω–∞ –≤–∞—à–∏—Ö —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞—Ö

## –†–∞–∑–≤–∏—Ç–∏–µ —Å–∏—Å—Ç–µ–º—ã

### –ü–ª–∞–Ω–∏—Ä—É–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

- [ ] OCR –¥–ª—è –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö PDF
- [ ] –ú–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞
- [ ] –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥—Ä—É–≥–∏—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ (Word, Excel)
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
- [ ] –°–∏—Å—Ç–µ–º–∞ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

### –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

```python
class AdvancedCertificateProcessor(CertificateProcessor):
    def extract_with_ocr(self, file_path):
        """OCR –¥–ª—è –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤"""
        pass
    
    def classify_certificate_type(self, text):
        """–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç–∏–ø–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞"""
        pass
    
    def extract_tables(self, file_path):
        """–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–∞–±–ª–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö"""
        pass
```

---

*–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: 2024-01-15*